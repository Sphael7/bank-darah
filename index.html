<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Logistik Darah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.2/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.2/brython_stdlib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* BASE THEMES */
        .theme-default { 
            background-color: #f3ffef; 
            background-image: linear-gradient(135deg, #e6f7ff 0%, #f7f9fc 70%);
        }
        .theme-ocean { 
            background-color: #e3f2fd; 
            background-image: linear-gradient(135deg, #bbdefb 0%, #e3f2fd 70%); 
        }
        .theme-sand { 
            background-color: #fff8e1; 
            background-image: linear-gradient(135deg, #ffe0b2 0%, #fff8e1 70%); 
        }
        .theme-steel { 
            background-color: #cfd8dc; 
            background-image: linear-gradient(135deg, #90a4ae 0%, #cfd8dc 70%); 
        }
        .theme-indigo { 
            background-color: #c5cae9; 
            background-image: linear-gradient(135deg, #9fa8da 0%, #c5cae9 70%); 
        }
        .theme-purple {
            background-color: #e8d9f4;
            background-image: linear-gradient(135deg, #d3bfff 0%, #e8d9f4 70%);
        }

        /* DEFAULT BODY STYLE */
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.5s ease, background-image 0.5s ease;
            background-color: #f3f4f6; 
            background-image: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 70%);
        }
        
        #input_dds_records {
            min-height: 180px; 
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }
        #output_text_container {
            background-color: #1f2937; 
            color: #d1d5db; 
            min-height: 250px; 
            transition: box-shadow 0.4s ease-in-out;
            overflow: auto; 
        }
        /* Styling untuk kontainer utama (Glassmorphism) - Diperlebar dari 6xl ke 7xl*/
        .main-container-glass {
            background-color: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            transition: background-color 0.5s ease, backdrop-filter 0.5s ease;
        }
        /* Styling untuk container visualisasi (Efek Glassmorphism pada layer kedua) */
        #chart_container {
            background-color: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(229, 231, 235, 0.3); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            /* Transisi untuk fade-in chart container */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #chart_container.show {
            opacity: 1;
        }

        /* FADE TRANSITION FOR THEME SELECTOR */
        #theme-selector-panel {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #theme-selector-panel.open {
            opacity: 1;
            visibility: visible;
        }

        /* Styling Matriks Keseimbangan */
        .balance-matrix {
            border-collapse: collapse;
            width: 100%;
            min-width: 750px; /* Ditambahkan agar tabel tidak terlalu menyempit */
            margin-top: 15px;
            font-size: 0.9em;
        }
        .balance-matrix th, .balance-matrix td {
            border: 1px solid #4b5563;
            padding: 8px;
            text-align: center;
        }
        .balance-matrix th {
            background-color: #374151;
            color: #facc15;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .balance-matrix td {
            background-color: #1f2937;
            color: #d1d5db;
        }
        .balance-matrix tr:nth-child(even) td {
            background-color: #111827;
        }
        .total-row {
            font-weight: bold;
            background-color: #374151 !important;
            color: #facc15 !important;
        }
        /* Style untuk Risk Score */
        .risk-score-high { color: #f87171; } /* Merah */
        .risk-score-medium { color: #facc15; } /* Kuning */
        .risk-score-low { color: #4ade80; } /* Hijau */
        
        /* Style untuk IKLR Tabel */
        .iklr-table th {
            background-color: #1e3a8a; /* Dark Blue */
            color: #ffffff;
            font-weight: normal;
        }
        .iklr-table td {
            font-family: 'Consolas', 'Courier New', monospace;
        }
        .iklr-table .score-good { color: #34d399; font-weight: bold; } /* Green */
        .iklr-table .score-avg { color: #facc15; } /* Yellow */
        .iklr-table .score-poor { color: #f87171; } /* Red */
    </style>
</head>
<body onload="brython()" class="theme-default">
    <div class="min-h-screen p-4 sm:p-8 flex flex-col items-center justify-start">
        
        <div id="theme-controls" class="fixed top-6 right-6 z-50"> 
            <button id="theme-toggle-button" class="p-3 bg-white text-gray-700 rounded-full shadow-lg hover:bg-gray-100 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.542-1.34 2.593-1.34 3.135 0l1.214 3.036a5.557 5.557 0 0 0 2.959 2.959l3.036 1.214c1.34.542 1.34 2.593 0 3.135l-3.036 1.214a5.557 5.557 0 0 0-2.959 2.959l-1.214 3.036c-.542 1.34-2.593 1.34-3.135 0l-1.214-3.036a5.557 5.557 0 0 0-2.959-2.959l-3.036-1.214c-1.34-.542-1.34-2.593 0-3.135l3.036-1.214a5.557 5.557 0 0 0 2.959-2.959l1.214-3.036Z" />
                </svg>
            </button>
            
            <div id="theme-selector-panel" class="absolute right-0 mt-2 p-4 bg-white rounded-xl shadow-2xl origin-top-right min-w-[200px]">
                <p class="text-sm font-semibold text-gray-800 mb-3 border-b pb-2">Tema</p>
                
                <div class="grid grid-cols-3 gap-3">
                    
                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-default')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" 
                                style="background-color: #f7f9fc; border: 2px solid #e0e7ff;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Default</span>
                    </div>

                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-ocean')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" 
                                style="background-color: #e3f2fd; border: 2px solid #bbdefb;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Ocean</span>
                    </div>

                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-sand')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2" 
                                style="background-color: #fff8e1; border: 2px solid #ffe0b2;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Sand</span>
                    </div>
                    
                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-steel')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" 
                                style="background-color: #cfd8dc; border: 2px solid #90a4ae;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Steel</span>
                    </div>

                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-indigo')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2" 
                                style="background-color: #c5cae9; border: 2px solid #9fa8da;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Indigo</span>
                    </div>

                    <div class="flex flex-col items-center group cursor-pointer" onclick="set_theme('theme-purple')">
                        <button class="w-10 h-10 rounded-xl shadow-md transition transform group-hover:scale-110 group-hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 focus:ring-offset-2" 
                                style="background-color: #e8d9f4; border: 2px solid #d3bfff;"></button>
                        <span class="mt-1 text-xs text-gray-600 font-medium group-hover:text-indigo-600 transition">Purple</span>
                    </div>

                </div>
            </div>
        </div>
        <div class="w-full max-w-7xl mx-auto shadow-2xl rounded-3xl p-6 md:p-10 border border-indigo-200/50 backdrop-blur-md mt-6 mb-12 main-container-glass">
            <h1 class="text-3xl font-extrabold text-indigo-800 mb-8 border-b-4 border-indigo-200 pb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 mr-3 text-red-500">
                    <path fill-rule="evenodd" d="M3.75 3.75A1.5 1.5 0 0 1 5.25 2.25h13.5A1.5 1.5 0 0 1 20.25 3.75v16.5A1.5 1.5 0 0 1 18.75 22.5H5.25A1.5 1.5 0 0 1 3.75 20.25V3.75ZM6 7.5a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H6ZM6 12a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H6ZM6 16.5a.75.75 0 0 0 0 1.5h12a.75.75 0 0 0 0-1.5H6Z" clip-rule="evenodd" />
                </svg>
                Sistem Analisis & Optimalisasi Logistik Darah
            </h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                
                <div class="md:border-r md:pr-5 border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Panel Data Masukan & Kontrol Analisis</h2>
                    
                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-blue-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                            </svg>
                            1. Mode Analisis (Subproblem)
                        </h3>
                        <div id="subproblem_selector" class="flex flex-wrap gap-3 text-sm">
                            <label class="inline-flex items-center bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-full cursor-pointer transition duration-300 ease-in-out hover:bg-indigo-100 shadow-md">
                                <input type="radio" name="subproblem" value="1" checked 
                                    class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 checked:bg-indigo-600">
                                <span class="ml-2 font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path d="M12 2.25a.75.75 0 0 1 .75.75v1.379l1.623 1.309A3.75 3.75 0 0 0 18.75 9V16.5a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V9a3.75 3.75 0 0 0-1.623-2.612L11.25 4.379V3A.75.75 0 0 1 12 2.25ZM10.5 13.5h3A.75.75 0 0 0 14.25 12h-4.5a.75.75 0 0 0-.75.75v1.5Z" />
                                    </svg>
                                    Sub 1: IKLR (Indeks Kinerja Logistik Regional)
                                </span>
                            </label>
                            <label class="inline-flex items-center bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full cursor-pointer transition duration-300 ease-in-out hover:bg-indigo-100 hover:text-indigo-800 shadow-sm">
                                <input type="radio" name="subproblem" value="2" 
                                    class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 checked:bg-indigo-600">
                                <span class="ml-2 font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path fill-rule="evenodd" d="M4.5 7.5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9Z" clip-rule="evenodd" />
                                    </svg>
                                    Sub 2: Detail Gol. Darah & Keseimbangan 📊
                                </span>
                            </label>
                            <label class="inline-flex items-center bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full cursor-pointer transition duration-300 ease-in-out hover:bg-indigo-100 hover:text-indigo-800 shadow-sm">
                                <input type="radio" name="subproblem" value="3" 
                                    class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 checked:bg-indigo-600">
                                <span class="ml-2 font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path d="M12 7.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9Z" />
                                        <path fill-rule="evenodd" d="M1.5 12a10.5 10.5 0 1 1 21 0 10.5 10.5 0 0 1-21 0ZM12 4.5a7.5 7.5 0 1 0 0 15 7.5 7.5 0 0 0 0-15Z" clip-rule="evenodd" />
                                    </svg>
                                    Sub 3: Opt. Pengambilan (Vol. Terbesar)
                                </span>
                            </label>
                            <label class="inline-flex items-center bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full cursor-pointer transition duration-300 ease-in-out hover:bg-indigo-100 hover:text-indigo-800 shadow-sm">
                                <input type="radio" name="subproblem" value="4" 
                                    class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 checked:bg-indigo-600">
                                <span class="ml-2 font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                                    </svg>
                                    Sub 4: Opt. Cepat (Vol. Terkecil)
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-6 space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-300 pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-red-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 17.5 3.375-3.375A.75.75 0 0 0 19.5 13.5h-7.5m0-12V5.25A2.25 2.25 0 0 0 7.5 7.5v12a2.25 2.25 0 0 0 2.25 2.25h12.75a.75.75 0 0 0 .75-.75v-11.25M12 5.25a2.25 2.25 0 0 0-2.25-2.25h-3a2.25 2.25 0 0 0-2.25 2.25v3a2.25 2.25 0 0 0 2.25 2.25h3a2.25 2.25 0 0 0 2.25-2.25v-3Z" />
                            </svg>
                            2. Data Operasional
                        </h3>

                        <div class="p-3 bg-indigo-50 rounded-xl shadow-inner border border-indigo-200">
                            <p class="text-sm font-bold text-indigo-700 mb-2">A. Parameter Utama (N & M) - Akan Dihitung Ulang Otomatis</p>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label for="input_N" class="text-xs font-medium text-gray-600">N (Jumlah Total DDS)</label>
                                    <input id="input_N" type="number" placeholder="Contoh: 24" value="24" disabled class="w-full p-2 border border-indigo-300 bg-indigo-100 rounded-lg focus:ring-indigo-500 transition shadow-sm">
                                </div>
                                <div class="flex-1">
                                    <label for="input_M" class="text-xs font-medium text-gray-600">M (Jumlah Desa/Lokasi)</label>
                                    <input id="input_M" type="number" placeholder="Contoh: 3" value="3" disabled class="w-full p-2 border border-indigo-300 bg-indigo-100 rounded-lg focus:ring-indigo-500 transition shadow-sm">
                                </div>
                            </div>
                        </div>

                        <div class="p-3 bg-gray-100 rounded-xl shadow-inner border border-gray-200">
                            <h4 class="text-sm font-bold text-indigo-700 mb-2">B. Data Setiap Pendonor (DDS Records)</h4>
                            <p class="text-xs text-gray-500 mb-2">Format: <span class="font-mono text-xs text-gray-700">KodeDesa GolonganDarah Volume</span></p>
                            <textarea id="input_dds_records" placeholder="Contoh:
1 1 250
2 4 500
1 1 300
3 2 450" 
                            class="w-full p-3 border border-gray-400 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-inner" >3 1 200
1 4 100
3 1 300
3 1 200
1 3 400
1 3 300
3 3 50
2 2 150
3 4 400
3 4 50
3 4 400
3 4 200
1 3 50
3 2 150
2 2 300
1 3 350
2 2 100
2 3 0
2 4 150
2 3 50
1 4 350
1 4 150
2 1 50
2 3 250</textarea>
                             <button id="load_example_button" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center transition">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1">
                                    <path fill-rule="evenodd" d="M11.54 22.351A8.28 8.28 0 0 0 22.35 11.54L22.21 11.21l-10.8-10.8a.75.75 0 0 0-1.06 0l-10.8 10.8.14.331a8.28 8.28 0 0 0 10.8 10.8ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75ZM15 15.75a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-1.5 0v4.5Z" clip-rule="evenodd" />
                                </svg>
                                Muat Contoh Data Awal (4 Baris)
                            </button>
                        </div>

                        <div class="p-3 bg-red-50 border border-red-200 rounded-xl shadow-inner">
                            <p class="text-sm font-bold text-red-700 mb-2">C. Kebutuhan Darah (Untuk Subproblem 3 & 4)</p>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label for="input_gd_kebutuhan" class="text-xs font-medium text-gray-600">Kode GD Kebutuhan (1=A, 4=O)</label>
                                    <input id="input_gd_kebutuhan" type="number" placeholder="Contoh: 1" value="4" class="w-full p-2 border border-red-300 rounded-lg focus:ring-red-500 transition shadow-sm">
                                </div>
                                <div class="flex-1">
                                    <label for="input_volume_kebutuhan" class="text-xs font-medium text-gray-600">Volume Kebutuhan (ml)</label>
                                    <input id="input_volume_kebutuhan" type="number" placeholder="Contoh: 500" value="1000" class="w-full p-2 border border-red-300 rounded-lg focus:ring-red-500 transition shadow-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="run_button" 
                            class="w-full px-8 py-3 bg-indigo-600 text-white font-extrabold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-[1.01] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-indigo-300/70">
                        ▶ EKSEKUSI ANALISIS
                    </button>
                    <p id="status_message" class="mt-4 text-sm text-red-500 hidden text-center font-medium animate-pulse">Memproses data...</p>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-gray-700">
                            <path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                        </svg>
                        Laporan Hasil Analisis
                    </h2>
                    
                    <div id="export-controls" class="mb-4 flex flex-wrap gap-3">
                        <button id="export_txt_button" class="px-3 py-1.5 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v12.553l2.843-2.843a.75.75 0 1 1 1.06 1.06l-4.125 4.125a.75.75 0 0 1-1.06 0l-4.125-4.125a.75.75 0 1 1 1.06-1.06l2.843 2.843V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M3 15.75a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                            </svg>
                            Ekspor Laporan (TXT)
                        </button>
                        <button id="export_csv_button" class="px-3 py-1.5 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v12.553l2.843-2.843a.75.75 0 1 1 1.06 1.06l-4.125 4.125a.75.75 0 0 1-1.06 0l-4.125-4.125a.75.75 0 1 1 1.06-1.06l2.843 2.843V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M3 15.75a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                            </svg>
                            Ekspor Data Mentah (CSV)
                        </button>
                    </div>
                    <div id="output_text_container" class="p-6 border border-gray-700 rounded-xl shadow-2xl">
                        <div id="output_text">
                            </div>
                    </div>
                </div>
            </div>

            <div id="visualization_section" class="mt-12 hidden">
                <h2 id="chart_title" class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-yellow-500">
                        <path fill-rule="evenodd" d="M2.25 13.5A.75.75 0 0 1 3 12.75h6.75a.75.75 0 0 1 .75.75v6.75a.75.75 0 0 1-.75.75H3a.75.75 0 0 1-.75-.75v-6.75ZM10.5 5.25a.75.75 0 0 0-.75.75v12.75a.75.75 0 0 0 .75.75h6.75a.75.75 0 0 0 .75-.75V6a.75.75 0 0 0-.75-.75h-6.75ZM18 10.5a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                    </svg>
                    Visualisasi Data
                </h2>
                <div id="chart_container" class="p-4 rounded-xl">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Global variable to hold the last analysis output for export
        let lastAnalysisHtml = "Belum ada laporan analisis yang dijalankan.";
        let lastRawData = []; 
        
        // ==========================================================
        // JAVASCRIPT LOGIC (THEME, CHART, and EXPORT)
        // ==========================================================
        let mainChartInstance = null;
        let hideChartTimer = null; 
        
        // Daftar semua kelas tema yang ada
        const ALL_THEMES = ['theme-default', 'theme-ocean', 'theme-sand', 'theme-steel', 'theme-indigo', 'theme-purple'];
        const BODY_ELEM = document.body;
        const THEME_SELECTOR_PANEL = document.getElementById('theme-selector-panel');

        // Fungsi untuk mengubah tema
        window.set_theme = function(themeClass) {
            ALL_THEMES.forEach(theme => BODY_ELEM.classList.remove(theme));
            BODY_ELEM.classList.add(themeClass);
        }

        // Fungsi untuk mengontrol transisi fade in/out
        function toggleThemePanel(force) {
            const isOpen = THEME_SELECTOR_PANEL.classList.contains('open');

            if (force === true || !isOpen) {
                THEME_SELECTOR_PANEL.classList.add('open');
            } else if (force === false || isOpen) {
                THEME_SELECTOR_PANEL.classList.remove('open');
            }
        }
        
        document.getElementById('theme-toggle-button').addEventListener('click', (e) => {
            e.stopPropagation(); 
            toggleThemePanel();
        });

        // LOGIKA CLICK OUTSIDE
        document.addEventListener('click', (e) => {
            const isClickInsidePanel = THEME_SELECTOR_PANEL.contains(e.target);
            const isClickOnToggleButton = document.getElementById('theme-toggle-button').contains(e.target);

            if (!isClickInsidePanel && !isClickOnToggleButton && THEME_SELECTOR_PANEL.classList.contains('open')) {
                toggleThemePanel(false); 
            }
        });


        // --- FUNGSI CHART BARU DAN DIPERBAIKI ---

        window.draw_chart = function(chart_type, title, labels, datasets) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chartSection = document.getElementById('visualization_section');
            const chartContainer = document.getElementById('chart_container');
            
            // 1. Hancurkan chart lama secara SINKRON
            if (mainChartInstance) {
                mainChartInstance.destroy();
                mainChartInstance = null; 
            }

            // 2. Pastikan kontainer siap
            chartSection.classList.remove('hidden'); 
            
            document.getElementById('chart_title').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-yellow-500">
                <path fill-rule="evenodd" d="M2.25 13.5A.75.75 0 0 1 3 12.75h6.75a.75.75 0 0 1 .75.75v6.75a.75.75 0 0 1-.75.75H3a.75.75 0 0 1-.75-.75v-6.75ZM10.5 5.25a.75.75 0 0 0-.75.75v12.75a.75.75 0 0 0 .75.75h6.75a.75.75 0 0 0 .75-.75V6a.75.75 0 0 0-.75-.75h-6.75ZM18 10.5a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
            </svg>${title}`;

            let y_axis_title = (chart_type === 'line') ? 'Volume Darah (ml)' : 'Jumlah Pendonor';
            let aspect_ratio = 1.0; 
            let chart_type_js = chart_type; 
            
            // Konfigurasi Chart.js options
            let scales = {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: y_axis_title, color: '#d1d5db' },
                    ticks: { color: '#d1d5db' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: '#d1d5db' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            };
            
            // Subproblem 2: Stacked Bar
            if (chart_type === 'bar_stacked') {
                 aspect_ratio = 1.0; 
                 scales = {
                    x: {
                        stacked: true,
                        ticks: { color: '#d1d5db' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Total Volume Darah (ml)', color: '#d1d5db' },
                        ticks: { color: '#d1d5db' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                 };
                 chart_type_js = 'bar';
            } else if (chart_type === 'bar_risk') {
                 // Chart untuk Risk Score
                 aspect_ratio = 1.2;
                 chart_type_js = 'bar';
                 scales.y.title.text = 'Skor Risiko (Rasio Ketersediaan/Demand)';
                 scales.y.reverse = true; 
                 scales.y.max = 1.2;
                 scales.y.min = 0;
                 scales.y.ticks.callback = function(value, index, ticks) {
                     if (value >= 1.0) return 'Skor: ' + value + ' (Low Risk)';
                     if (value >= 0.5) return 'Skor: ' + value + ' (Medium Risk)';
                     return 'Skor: ' + value + ' (High Risk)';
                 }
                 scales.y.grid.color = function(context) {
                     if (context.tick.value >= 1.0) return 'rgba(34, 197, 94, 0.5)'; // Hijau
                     if (context.tick.value >= 0.5) return 'rgba(251, 191, 36, 0.5)'; // Kuning
                     return 'rgba(239, 68, 68, 0.5)'; // Merah
                 }
            } else if (chart_type === 'radar') {
                 // Chart untuk IKLR Radar
                 aspect_ratio = 1.0;
                 chart_type_js = 'radar';
                 scales = {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                        grid: { color: 'rgba(255, 255, 255, 0.3)' },
                        pointLabels: { color: '#d1d5db', font: { size: 12 } },
                        suggestedMin: 0,
                        suggestedMax: 100, // Normalized to 100
                        ticks: {
                            color: '#d1d5db',
                            backdropColor: 'rgba(31, 41, 55, 0.8)',
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                 };
            }

            mainChartInstance = new Chart(ctx, {
                type: chart_type_js,
                data: {
                    labels: labels, 
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: aspect_ratio,
                    plugins: {
                        legend: {
                            labels: { color: '#d1d5db' }
                        }
                    },
                    scales: scales
                }
            });
            
            ctx.canvas.style.backgroundColor = 'transparent';
            
            // 3. Terapkan fade-in
            setTimeout(() => {
                chartContainer.classList.add('show');
            }, 0); 
        }

        // FUNGSI UTAMA UNTUK MENYEMBUNYIKAN CHART (dipanggil dari Brython saat input berubah)
        window.hide_chart = function() {
            const chartSection = document.getElementById('visualization_section');
            const chartContainer = document.getElementById('chart_container');

            // BATALKAN TIMER LAMA
            if (hideChartTimer) {
                clearTimeout(hideChartTimer);
                hideChartTimer = null;
            }
            
            // Pastikan Chart Container kehilangan kelas 'show' sebelum menyembunyikan section
            chartContainer.classList.remove('show');
            
            if (!chartSection.classList.contains('hidden')) {
                // Set timer baru untuk menyembunyikan
                hideChartTimer = setTimeout(() => {
                    chartSection.classList.add('hidden');
                    hideChartTimer = null;
                }, 500); 
            }
        }
        
        function load_example() {
            document.getElementById('input_N').value = 4;
            document.getElementById('input_M').value = 3;
            document.getElementById('input_dds_records').value = '1 1 250\n2 4 500\n1 1 300\n3 2 450';
            document.getElementById('input_gd_kebutuhan').value = 1;
            document.getElementById('input_volume_kebutuhan').value = 500;
            
            window.hide_chart(); 
            
            if (window.brython_runtime && window.brython_runtime.initialize_dashboard) {
                 window.brython_runtime.initialize_dashboard(); 
            } else {
                 setTimeout(() => window.brython_runtime.initialize_dashboard(), 100);
            }
        }

        document.getElementById('load_example_button').addEventListener('click', load_example);

        // Event listener pada input untuk menyembunyikan chart saat diubah
        document.getElementById('input_dds_records').addEventListener('input', window.hide_chart);
        document.getElementById('input_gd_kebutuhan').addEventListener('input', window.hide_chart);
        document.getElementById('input_volume_kebutuhan').addEventListener('input', window.hide_chart);


        // ... (Logika Export tetap sama) ...
        function download_file(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('export_txt_button').addEventListener('click', () => {
            const cleanText = lastAnalysisHtml
                .replace(/<[^>]*>?/gm, ' ') 
                .replace(/\s+/g, ' ')       
                .trim();
            const date = new Date().toISOString().slice(0, 10);
            download_file(cleanText, `Laporan_Darah_${date}.txt`, 'text/plain');
        });

        document.getElementById('export_csv_button').addEventListener('click', () => {
            if (lastRawData.length === 0) {
                alert("Jalankan analisis terlebih dahulu untuk menghasilkan data mentah (CSV).");
                return;
            }
            
            let csvContent = "KodeDesa,GolonganDarah,Volume(ml)\n";
            lastRawData.forEach(row => {
                csvContent += `${row.join(',')}\n`;
            });

            const date = new Date().toISOString().slice(0, 10);
            download_file(csvContent, `DataMentah_DDS_${date}.csv`, 'text/csv;charset=utf-8;');
        });

    </script>

    <script type="text/python">
        from browser import document, console, html, window
        from collections import defaultdict
        import math
        
        window.brython_runtime = {}
        
        # Konstanta untuk kode golongan darah
        GOLONGAN_DARAH_MAP = {
            1: "A", 2: "B", 3: "AB", 4: "O"
        }
        
        GOLONGAN_DARAH_LIST = sorted(GOLONGAN_DARAH_MAP.keys())
        
        # KONSTANTA INOVATIF (PROXY DEMAND)
        GD_DEMAND_PROXY = { 
            1: 0.35,  # A: 35%
            2: 0.25,  # B: 25%
            3: 0.10,  # AB: 10% (Langgan dan Universal Recipient)
            4: 0.30   # O: 30% (Universal Donor, Paling Penting)
        }
        
        # GD Prioritas untuk Metrik B (Utama: O dan AB)
        GD_PRIORITAS = [3, 4] 
        
        # KONFIGURASI CHART STANDAR (Kuning Line Chart)
        DEFAULT_LINE_CHART_CONFIG = {
            'borderColor': '#facc15',
            'backgroundColor': 'rgba(250, 204, 21, 0.2)',
            'tension': 0.4, 
            'fill': 'start',
            'pointBackgroundColor': '#facc15',
            'borderWidth': 3
        }
        # Warna untuk Stacked Bar (Sub 2)
        GD_CHART_COLORS = {
            1: 'rgba(239, 68, 68, 0.8)', # Red
            2: 'rgba(59, 130, 246, 0.8)', # Blue
            3: 'rgba(168, 85, 247, 0.8)', # Purple
            4: 'rgba(250, 204, 21, 0.8)' # Yellow
        }
        # Warna untuk IKLR Radar Chart
        IKLR_RADAR_COLORS = [
            'rgba(52, 211, 153, 0.8)', # Green
            'rgba(59, 130, 246, 0.8)', # Blue
            'rgba(249, 115, 22, 0.8)', # Orange
            'rgba(168, 85, 247, 0.8)'  # Purple
        ]
        IKLR_RADAR_BG_COLORS = [
            'rgba(52, 211, 153, 0.1)',
            'rgba(59, 130, 246, 0.1)',
            'rgba(249, 115, 22, 0.1)',
            'rgba(168, 85, 247, 0.1)'
        ]


        def get_parsed_data(input_lines):
            dds_records = []
            for line in input_lines:
                try:
                    parts = [int(p) for p in line.strip().split() if p]
                    if len(parts) == 3 and parts[2] > 0:
                        dds_records.append(tuple(parts))
                except ValueError:
                    continue
            return dds_records
            
        def get_all_inputs():
            M_input = int(document["input_M"].value) if document["input_M"].value else 0
            
            DDS_lines = document["input_dds_records"].value.strip().splitlines()
            GD_Keb = int(document["input_gd_kebutuhan"].value) if document["input_gd_kebutuhan"].value else 0
            Volume_Keb = int(document["input_volume_kebutuhan"].value) if document["input_volume_kebutuhan"].value else 0
            
            dds_data = get_parsed_data(DDS_lines)
            
            # Recalculate N and M based on data
            N_actual = len(dds_data)
            M_actual_from_data = max([d[0] for d in dds_data]) if dds_data else M_input 
            
            # Update inputs based on actual data
            document["input_N"].value = str(N_actual)
            document["input_M"].value = str(M_actual_from_data)
            
            desa_labels = [f"Desa {i}" for i in range(1, M_actual_from_data + 1)]

            return N_actual, M_actual_from_data, dds_data, GD_Keb, Volume_Keb, desa_labels

        def calculate_initial_stats():
            _, _, dds_data, _, _, _ = get_all_inputs()
            N_actual = len(dds_data)
            M_actual = max([d[0] for d in dds_data]) if dds_data else 0
            total_volume = sum([d[2] for d in dds_data])
            
            return N_actual, M_actual, total_volume

        # Diperbarui: Hanya menampilkan pesan instruksi, tidak ada output analisis awal.
        def generate_dashboard_html():
            html_content = f"""
            <div class="space-y-4 p-4 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto text-indigo-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 16.5h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                </svg>
                <h4 class='text-xl font-extrabold text-blue-400 mb-2'>Siap untuk Analisis</h4>
                <p class="text-md text-gray-400">Sistem Logistik Darah siap memproses data Anda.</p>
                <p class="text-sm text-yellow-400 mt-3 font-semibold">Langkah Selanjutnya:</p>
                <ol class="list-decimal list-inside text-left mx-auto max-w-xs text-gray-300">
                    <li>Pastikan Data Operasional sudah benar di panel kiri.</li>
                    <li>Pilih <span class='font-bold'>Mode Analisis</span> (Subproblem 1-4).</li>
                    <li>Tekan tombol <span class='font-bold'>▶ EKSEKUSI ANALISIS</span> di bawah.</li>
                </ol>
            </div>
            """
            return html_content
        
        def initialize_dashboard():
            document["output_text"].innerHTML = generate_dashboard_html()
        
        window.brython_runtime['initialize_dashboard'] = initialize_dashboard

        # --- FUNGSI INOVATIF: HITUNG SKOR RISIKO ---
        def calculate_risk_score(dds_data, M):
            volume_by_gd = defaultdict(int)
            total_volume_global = 0
            
            for _, gd, volume in dds_data:
                volume_by_gd[gd] += volume
                total_volume_global += volume

            risk_results = {}
            average_daily_demand = 500
            
            if total_volume_global == 0:
                 return {}, 0 

            for gd_code in GOLONGAN_DARAH_LIST:
                volume_stok = volume_by_gd[gd_code]
                
                # Ideal Demand Volume dihitung sebagai porsi GD_DEMAND_PROXY dari total volume global
                ideal_demand_volume = total_volume_global * GD_DEMAND_PROXY[gd_code]

                if ideal_demand_volume > 0:
                    risk_score = volume_stok / ideal_demand_volume
                else:
                    # Jika ideal demand > 0 (GD_DEMAND_PROXY[gd_code] > 0) tapi volume_stok = 0, risk = 0.
                    # Jika ideal demand = 0 (misal GD_DEMAND_PROXY = 0), set risk_score = 1.0 (resiko rendah)
                    risk_score = 1.0 
                
                # Tambahan Days Supply
                daily_demand_gd = average_daily_demand * GD_DEMAND_PROXY[gd_code]
                days_supply = (volume_stok / daily_demand_gd) if daily_demand_gd > 0 else 0

                risk_results[gd_code] = {
                    'score': round(risk_score, 2),
                    'volume': volume_stok,
                    'days_supply': round(days_supply, 1),
                    'status': 'Rendah' if risk_score >= 1.0 else ('Sedang' if risk_score >= 0.5 else 'Tinggi')
                }

            return risk_results, total_volume_global
        # --- END FUNGSI INOVATIF ---


        # --- SUBPROBLEM 1: INDEKS KINERJA LOGISTIK REGIONAL (IKLR) ---
        def solve_subproblem_1(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels):
            if not dds_data or M == 0:
                 # Gunakan calculate_initial_stats untuk menampilkan N, M, Volume (di sini sebagai fallback)
                 N_stat, M_stat, V_stat = calculate_initial_stats()
                 return (f"<h4 class='text-xl font-extrabold text-blue-400 mb-3'>Ringkasan Data Awal</h4>"
                         f"<p class='text-white'>Total Pendonor (N): <span class='font-bold text-yellow-400'>{N_stat}</span></p>"
                         f"<p class='text-white'>Jumlah Desa (M): <span class='font-bold text-yellow-400'>{M_stat}</span></p>"
                         f"<p class='text-red-400 font-bold mt-4'>Error: Data DDS tidak ditemukan atau Kode Desa (M) tidak valid untuk analisis IKLR.</p>"), None

            stats_by_desa = defaultdict(lambda: {'count': 0, 'volume': 0, 'gd_types': set(), 'volume_prioritas': 0})
            total_volume_global = sum(d[2] for d in dds_data)
            
            for kode_desa, gd_code, volume in dds_data:
                if 1 <= kode_desa <= M: 
                    stats_by_desa[kode_desa]['count'] += 1
                    stats_by_desa[kode_desa]['volume'] += volume
                    stats_by_desa[kode_desa]['gd_types'].add(gd_code)
                    if gd_code in GD_PRIORITAS:
                        stats_by_desa[kode_desa]['volume_prioritas'] += volume

            # 1. Perhitungan Metrik Global (Baseline)
            N_global = N
            avg_volume_global = total_volume_global / N_global if N_global > 0 else 0
            
            # 2. Perhitungan dan Normalisasi IKLR per Desa
            iklr_results = {}
            for i in range(1, M + 1):
                desa_data = stats_by_desa.get(i, {'count': 0, 'volume': 0, 'gd_types': set(), 'volume_prioritas': 0})
                D_i = desa_data['count']
                V_i = desa_data['volume']
                P_i = desa_data['volume_prioritas']
                T_i = len(desa_data['gd_types']) # Jumlah unik GD
                
                if D_i == 0:
                    iklr_results[i] = {'count': 0, 'avg_vol': 0.0, 'ratio_p': 0.0, 'score_t': 0.0, 'iklr_score': 0.0, 'A_norm': 0.0, 'B_norm': 0.0, 'C_norm': 0.0}
                    continue
                
                # METRIK A: Rata-rata Volume (Kualitas)
                avg_volume_i = V_i / D_i 
                # Normalisasi A: Rasio terhadap Rata-rata Global (capped di 150% untuk menghindari skew)
                metric_A_score = min(1.5, avg_volume_i / avg_volume_global) * 100 if avg_volume_global > 0 else 0

                # METRIK B: Rasio GD Prioritas (Strategi)
                ratio_prioritas_i = P_i / V_i
                # Normalisasi B: Persentase (Idealnya setara dengan total GD_DEMAND_PROXY Prioritas)
                target_prioritas = sum(GD_DEMAND_PROXY[gd] for gd in GD_PRIORITAS)
                # Normalisasi terhadap target (~40% dalam kasus default)
                metric_B_score = min(1.5, ratio_prioritas_i / target_prioritas) * 100 if target_prioritas > 0 else 0

                # METRIK C: Skor Keberagaman (Resiliensi)
                # Normalisasi C: Rasio terhadap 4 GD
                metric_C_score = (T_i / 4.0) * 100
                
                # IKLR Score: Rata-rata Sederhana dari 3 Metrik
                iklr_score = (metric_A_score + metric_B_score + metric_C_score) / 3.0
                
                iklr_results[i] = {
                    'count': D_i, 
                    'avg_vol': round(avg_volume_i, 1), 
                    'ratio_p': round(ratio_prioritas_i * 100, 1), # dalam %
                    'score_t': round(metric_C_score, 1),
                    'iklr_score': round(iklr_score, 1),
                    'A_norm': round(metric_A_score, 1),
                    'B_norm': round(metric_B_score, 1),
                    'C_norm': round(metric_C_score, 1)
                }

            # 3. Output HTML
            
            html_output = ["<h4 class='text-xl font-extrabold text-blue-400 mb-3'>Rekapitulasi Total Pendonor per Desa</h4>"]
            html_output.append("<ul class='list-none space-y-2 p-2 rounded-lg bg-gray-700/50 mb-6'>")
            
            total_semua_desa = sum(iklr_results[i]['count'] for i in range(1, M + 1))
            for i in range(1, M + 1):
                jumlah = iklr_results[i]['count']
                html_output.append(
                    f"<li class='flex justify-between border-b border-gray-600 pb-1'>"
                    f"<span>Desa <span class='font-bold text-yellow-400'>0{i}</span>:</span>"
                    f"<span class='font-extrabold text-white'>{jumlah} Pendonor</span>"
                    f"</li>"
                )
            
            html_output.append("</ul>")
            html_output.append(f"<p class='mt-2 text-lg font-bold text-white'>Total Keseluruhan Pendonor Terdaftar: <span class='text-yellow-400'>{total_semua_desa}</span> orang.</p>")
            
            # --- Bagian IKLR Baru (Tanpa Emoji dan Header Disesuaikan) ---
            html_output.append("<hr class='my-6 border-indigo-700'>")
            html_output.append("<h4 class='text-xl font-extrabold text-green-400 mb-3'>Indeks Kinerja Logistik Regional (IKLR)</h4>")
            html_output.append("<p class='text-sm text-gray-400 mb-4'>Analisis kualitas dan resiliensi donasi tiap desa dibandingkan rata-rata sistem. Semakin tinggi skor, semakin efisien dan strategis donasi desa tersebut.</p>")

            html_output.append("<div class='overflow-x-auto max-h-96'>")
            # Tambahkan class CSS 'iklr-table' yang akan dipengaruhi oleh min-width: 750px
            html_output.append("<table class='balance-matrix iklr-table'>")
            
            # Header
            html_output.append("<thead><tr><th>Desa</th>")
            html_output.append("<th>Total Pendonor</th>")
            html_output.append("<th>Metrik A: Rata-rata Volume (ml)</th>")
            html_output.append("<th>Metrik B: Rasio GD Prioritas (O & AB) (%)</th>")
            html_output.append("<th>Metrik C: Skor Keberagaman (%)</th>")
            html_output.append("<th>S.A IKLR (%)</th></tr></thead>") # SKOR AKHIR IKLR (%) diganti S.A IKLR (%)
            
            # Body
            html_output.append("<tbody>")
            
            for i in range(1, M + 1):
                res = iklr_results[i]
                
                # Tentukan warna untuk skor akhir (hapus icon)
                if res['iklr_score'] >= 80:
                    score_class = 'score-good'
                elif res['iklr_score'] >= 50:
                    score_class = 'score-avg'
                else:
                    score_class = 'score-poor'
                
                # Logika Outlier (sederhana: jika metrik A > 120% global)
                avg_vol_style = "text-white"
                if avg_volume_global > 0 and (res['avg_vol'] / avg_volume_global) > 1.2:
                    avg_vol_style = "score-good font-bold"
                elif res['avg_vol'] > 0 and (res['avg_vol'] / avg_volume_global) < 0.8:
                    avg_vol_style = "score-poor"

                html_output.append("<tr>")
                html_output.append(f"<td>Desa <span class='font-bold text-yellow-400'>0{i}</span></td>")
                html_output.append(f"<td>{res['count']}</td>")
                html_output.append(f"<td class='{avg_vol_style}'>{res['avg_vol']}</td>")
                html_output.append(f"<td>{res['ratio_p']}%</td>")
                html_output.append(f"<td>{res['score_t']}%</td>")
                html_output.append(f"<td class='{score_class}'>{res['iklr_score']}%</td>") # Hapus icon
                html_output.append("</tr>")

            html_output.append("</tbody></table></div>")
            
            # 4. Data Chart Radar (Ambil 3 Desa Terbaik IKLR)
            
            desa_ranking = sorted(iklr_results.items(), key=lambda item: item[1]['iklr_score'], reverse=True)
            top_desas = desa_ranking[:min(3, M)] 
            
            chart_datasets = []
            
            for index, (desa_kode, res) in enumerate(top_desas):
                chart_datasets.append({
                    'label': f'Desa 0{desa_kode} (IKLR: {res["iklr_score"]}%)',
                    'data': [res['A_norm'], res['B_norm'], res['C_norm']], # Data yang sudah dinormalisasi
                    'backgroundColor': IKLR_RADAR_BG_COLORS[index % len(IKLR_RADAR_BG_COLORS)],
                    'borderColor': IKLR_RADAR_COLORS[index % len(IKLR_RADAR_COLORS)],
                    'pointBackgroundColor': IKLR_RADAR_COLORS[index % len(IKLR_RADAR_COLORS)],
                    'borderWidth': 2,
                    'fill': True
                })

            radar_labels = ["Metrik A: Rata-rata Volume", "Metrik B: Rasio GD Prioritas (O & AB)", "Metrik C: Skor Keberagaman"]
            
            chart_data = ['radar', f"Visualisasi Kinerja Logistik Regional (IKLR) Top {len(top_desas)} Desa", radar_labels, chart_datasets]
            
            return "\n".join(html_output), chart_data 

        # --- SUBPROBLEM 2 (STACKED BAR & RISK ANALYSIS) ---
        def solve_subproblem_2(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels):
            if not dds_data or M == 0:
                 N_stat, M_stat, V_stat = calculate_initial_stats()
                 return (f"<h4 class='text-xl font-extrabold text-blue-400 mb-3'>Ringkasan Data Awal</h4>"
                         f"<p class='text-white'>Total Pendonor (N): <span class='font-bold text-yellow-400'>{N_stat}</span></p>"
                         f"<p class='text-white'>Jumlah Desa (M): <span class='font-bold text-yellow-400'>{M_stat}</span></p>"
                         f"<p class='text-red-400 font-bold mt-4'>Error: Data DDS tidak ditemukan atau Kode Desa (M) tidak valid.</p>"), None

            stats_by_desa_gd = defaultdict(lambda: defaultdict(lambda: [0, 0]))
            
            volume_by_gd_for_chart = {gd: [0] * M for gd in GOLONGAN_DARAH_LIST}

            for kode_desa, golongan_darah, volume_darah in dds_data:
                if 1 <= kode_desa <= M and 1 <= golongan_darah <= 4:
                    stats_by_desa_gd[kode_desa][golongan_darah][0] += 1
                    stats_by_desa_gd[kode_desa][golongan_darah][1] += volume_darah
                    if kode_desa - 1 < M:
                        volume_by_gd_for_chart[golongan_darah][kode_desa - 1] += volume_darah
            
            html_output = ["<h4 class='text-xl font-extrabold text-blue-400 mb-3'>Laporan Detail Golongan Darah & Keseimbangan Stok 📊</h4>"]
            
            # --- Bagian 1: Matriks Keseimbangan (Tabel) ---
            html_output.append("<h5 class='text-lg font-bold text-yellow-400 mt-4'>Matriks Volume Darah (ml) per Desa vs. Golongan Darah</h5>")
            
            html_output.append("<div class='overflow-x-auto max-h-96'>")
            html_output.append("<table class='balance-matrix'>")
            
            # Header
            html_output.append("<thead><tr><th>Desa/GD</th>")
            for gd_code in GOLONGAN_DARAH_LIST:
                html_output.append(f"<th>GD {GOLONGAN_DARAH_MAP[gd_code]}</th>")
            html_output.append("<th>TOTAL VOLUME (ml)</th></tr></thead>")
            
            # Body
            html_output.append("<tbody>")
            total_gd_col = defaultdict(int)
            total_global_volume = 0
            
            for desa_ke in range(1, M + 1):
                row_total = 0
                html_output.append("<tr>")
                html_output.append(f"<td>Desa 0{desa_ke}</td>")
                for gd_code in GOLONGAN_DARAH_LIST:
                    volume = stats_by_desa_gd[desa_ke][gd_code][1]
                    html_output.append(f"<td>{volume}</td>")
                    row_total += volume
                    total_gd_col[gd_code] += volume
                
                html_output.append(f"<td><span class='font-extrabold text-white'>{row_total}</span></td>")
                html_output.append("</tr>")
                total_global_volume += row_total

            # Footer (Total Baris)
            html_output.append("<tr class='total-row'><td>TOTAL GD</td>")
            for gd_code in GOLONGAN_DARAH_LIST:
                html_output.append(f"<td>{total_gd_col[gd_code]}</td>")
            html_output.append(f"<td>{total_global_volume}</td></tr>")
            
            html_output.append("</tbody></table></div>")

            # --- Bagian 2: Analisis Risiko Kekurangan Stok (GD Prioritas) ---
            
            risk_results, total_volume_global = calculate_risk_score(dds_data, M)

            html_output.append("<h4 class='text-xl font-extrabold text-blue-400 mb-3 mt-8 border-b border-gray-600 pb-2'>Analisis Risiko Kekurangan Stok (GD Prioritas) 🚨</h4>")
            html_output.append(f"<p class='text-sm text-gray-400 mb-4'>Skor Risiko = Stok Aktual / Stok Ideal (Ideal dihitung berdasarkan Proxy Demand: {', '.join([f'{GOLONGAN_DARAH_MAP[k]}: {int(v*100)}%' for k,v in GD_DEMAND_PROXY.items()])}). Skor &ge; 1.0 adalah risiko Rendah.</p>")

            html_output.append("<ul class='list-none space-y-3 p-3 bg-gray-700/70 rounded-xl'>")
            
            risk_scores_data = []
            risk_labels = []
            
            for gd_code in GOLONGAN_DARAH_LIST:
                res = risk_results.get(gd_code, {'score': 0, 'days_supply': 0, 'volume': 0, 'status': 'N/A'})
                
                # Visual status
                color_class = 'risk-score-low' if res['status'] == 'Rendah' else ('risk-score-medium' if res['status'] == 'Sedang' else 'risk-score-high')
                icon = '✅' if res['status'] == 'Rendah' else ('⚠️' if res['status'] == 'Sedang' else '❌')
                
                html_output.append(
                    f"<li class='flex justify-between items-center border-b border-gray-600 pb-2'>"
                    f"<span class='text-lg font-extrabold text-white'>GD {GOLONGAN_DARAH_MAP[gd_code]}</span>"
                    f"<div class='text-right'>"
                    f"<p class='text-sm font-semibold'>Skor Risiko: <span class='font-extrabold {color_class}'>{res['score']}</span> ({res['status']} {icon})</p>"
                    f"<p class='text-xs text-gray-300'>Stok Bertahan: <span class='font-bold'>{res['days_supply']} hari</span> ({res['volume']} ml)</p>"
                    f"</div>"
                    f"</li>"
                )
                
                risk_scores_data.append(res['score'])
                risk_labels.append(f"GD {GOLONGAN_DARAH_MAP[gd_code]}")
            
            html_output.append("</ul>")

            # --- Bagian 3: Chart Visualisasi Matriks ---
            
            chart_datasets = []
            for gd_code in GOLONGAN_DARAH_LIST:
                chart_datasets.append({
                    'label': f'GD {GOLONGAN_DARAH_MAP[gd_code]} (ml)',
                    'data': volume_by_gd_for_chart[gd_code],
                    'backgroundColor': GD_CHART_COLORS[gd_code],
                    'borderColor': GD_CHART_COLORS[gd_code].replace('0.8', '1')
                })

            chart_data = ['bar_stacked', "Stacked Volume Darah per Desa (Matriks Keseimbangan)", desa_labels, chart_datasets]
            
            return "\n".join(html_output), chart_data

        # --- FUNGSI UTAMA OPTIMASI (SUB 3 & 4) - Dengan Audit Logistik Sisa ---
        def solve_subproblem_optimasi(N, M, dds_data, kebutuhan_gd_code, kebutuhan_volume, mode, desa_labels):
            if not dds_data or M == 0:
                N_stat, M_stat, V_stat = calculate_initial_stats()
                return (f"<h4 class='text-xl font-extrabold text-blue-400 mb-3'>Ringkasan Data Awal</h4>"
                        f"<p class='text-white'>Total Pendonor (N): <span class='font-bold text-yellow-400'>{N_stat}</span></p>"
                        f"<p class='text-white'>Jumlah Desa (M): <span class='font-bold text-yellow-400'>{M_stat}</span></p>"
                        f"<p class='text-red-400 font-bold mt-4'>Error: Data DDS tidak ditemukan atau Kode Desa (M) tidak valid.</p>"), None
            if not (1 <= kebutuhan_gd_code <= 4) or kebutuhan_volume <= 0:
                 return f"<span class='text-red-400 font-bold'>Error:</span> Harap masukkan GD Kebutuhan (1-4) dan Volume Kebutuhan (>0) yang valid.", None

            kebutuhan_gd_label = GOLONGAN_DARAH_MAP.get(kebutuhan_gd_code, "GD Tidak Dikenal")
            
            # --- STOCK AWAL ---
            primary_stock = defaultdict(int)
            universal_stock = defaultdict(int) 
            initial_stock_by_gd = defaultdict(int) # Stock awal global
            
            for kode_desa, golongan_darah, volume_darah in dds_data:
                initial_stock_by_gd[golongan_darah] += volume_darah
                if 1 <= kode_desa <= M:
                    if golongan_darah == kebutuhan_gd_code:
                        primary_stock[kode_desa] += volume_darah
                    if golongan_darah == 4 and kebutuhan_gd_code != 4: 
                        universal_stock[kode_desa] += volume_darah
            
            # --- Logika Optimasi (Sama) ---
            def run_greedy_optimization(stock_dict, current_needs, optimization_mode):
                sorted_donors = [(volume, desa_code) for desa_code, volume in stock_dict.items() if volume > 0]
                
                if optimization_mode == 'volume':
                    sorted_donors.sort(key=lambda x: x[0], reverse=True) 
                elif optimization_mode == 'buffer':
                    sorted_donors.sort(key=lambda x: (x[0], x[1])) 

                collected = 0
                selections = [] # (kode_desa, volume_diambil, volume_sisa)
                
                for volume, kode_desa in sorted_donors:
                    volume_diambil = min(volume, current_needs - collected)
                    volume_sisa = volume - volume_diambil
                    
                    if volume_diambil > 0:
                        collected += volume_diambil
                        selections.append((kode_desa, volume_diambil, volume_sisa))
                    
                    if collected >= current_needs:
                        break
                        
                return collected, selections

            # 1. Tahap 1: Ambil GD Spesifik
            volume_terkumpul_primary, selections_primary = run_greedy_optimization(primary_stock, kebutuhan_volume, mode)
            volume_kekurangan = max(0, kebutuhan_volume - volume_terkumpul_primary)
            volume_terkumpul = volume_terkumpul_primary
            
            # 2. Tahap 2: Fallback ke GD O
            selections_universal = []
            volume_terkumpul_universal = 0
            
            if volume_kekurangan > 0 and kebutuhan_gd_code != 4: 
                volume_terkumpul_universal, selections_universal = run_greedy_optimization(universal_stock, volume_kekurangan, mode)
                volume_terkumpul += volume_terkumpul_universal
            
            # --- START HITUNG SKOR & AUDIT SISA ---
            
            # Stok Global Pasca-Optimasi
            final_stock_by_gd = initial_stock_by_gd.copy()
            stok_sisa_per_desa = defaultdict(lambda: {'GD_PRIM': 0, 'GD_UNIV': 0})
            
            # Proses Audit Sisa GD Utama
            for kode_desa, diambil, sisa in selections_primary:
                final_stock_by_gd[kebutuhan_gd_code] -= diambil
                stok_sisa_per_desa[kode_desa]['GD_PRIM'] = sisa
            
            # Proses Audit Sisa GD Universal (O=4)
            for kode_desa, diambil, sisa in selections_universal:
                final_stock_by_gd[4] -= diambil
                stok_sisa_per_desa[kode_desa]['GD_UNIV'] = sisa
            
            # Ulangi perhitungan risiko dengan stok yang telah dikurangi
            dds_data_final = []
            for gd, vol in final_stock_by_gd.items():
                # Simulasi data DDS sisa untuk perhitungan risiko
                 dds_data_final.extend([(1, gd, vol)]) # Gunakan kode desa 1 untuk agregat total volume sisa

            # Hitung Risiko Pasca-Optimasi (Hanya untuk GD yang terlibat)
            risk_after = {}
            total_volume_after = sum(final_stock_by_gd.values())
            
            for gd_code in [kebutuhan_gd_code, 4]: 
                 vol_after = final_stock_by_gd[gd_code]
                 
                 # Pastikan GD_DEMAND_PROXY tidak nol
                 if GD_DEMAND_PROXY[gd_code] > 0 and total_volume_after > 0:
                    ideal_demand_after = total_volume_after * GD_DEMAND_PROXY[gd_code]
                    risk_score_after = vol_after / ideal_demand_after
                 elif vol_after > 0:
                    # Jika GD_DEMAND_PROXY nol tapi masih ada stok, anggap risiko rendah
                    risk_score_after = 1.0
                 else:
                    risk_score_after = 0.0

                 risk_after[gd_code] = {
                    'score': round(risk_score_after, 2),
                    'volume': vol_after,
                    'status': 'Rendah' if risk_score_after >= 1.0 else ('Sedang' if risk_score_after >= 0.5 else 'Tinggi')
                 }
            
            # Hitung SEP Score
            unique_desa_selections = set([d[0] for d in selections_primary + selections_universal])
            actual_desa_count = len(unique_desa_selections)
            max_volume_primary = max(primary_stock.values()) if primary_stock else 0
            
            if volume_terkumpul >= kebutuhan_volume:
                # Heuristic: Idealnya 1 desa, atau 2 desa jika GD spesifik kurang
                ideal_desa_count = 1 if max_volume_primary >= kebutuhan_volume else (2 if kebutuhan_gd_code != 4 and volume_terkumpul_primary < kebutuhan_volume else 1)
            else:
                 # Jika tidak terpenuhi, efisiensi dilihat dari minimnya desa yang *sudah* diambil
                 ideal_desa_count = actual_desa_count if actual_desa_count > 0 else 1

            if actual_desa_count == 0:
                sep_score = 0.0
            else:
                sep_ratio = ideal_desa_count / actual_desa_count 
                sep_score = min(100.0, sep_ratio * 100.0) 

            # --- START OUTPUT HTML ---
            
            subproblem_title = "Optimasi Pengambilan (Prioritas Volume Terbesar)" if mode == 'volume' else "Optimasi Cepat (Prioritas Volume Terkecil)"

            html_output = [f"<h4 class='text-xl font-extrabold text-blue-400 mb-3'>{subproblem_title}</h4>"]
            html_output.append(f"<p class='text-lg font-semibold text-white'>Kebutuhan Target: <span class='text-yellow-400 font-extrabold'>{kebutuhan_volume} ml</span> Darah Golongan <span class='text-yellow-400 font-extrabold'>{kebutuhan_gd_label}</span></p>")
            html_output.append("<hr class='my-3 border-gray-600'>")

            # OUTPUT SEP SCORE BARU
            sep_status_color = 'text-green-400' if sep_score >= 80 else ('text-yellow-400' if sep_score >= 50 else 'text-red-400')
            
            html_output.append(
                f"<div class='p-3 bg-indigo-900/50 rounded-xl mb-4 border border-indigo-700'>"
                f"<p class='text-md font-semibold text-white'>Skor Efektivitas Pengambilan (SEP): <span class='font-extrabold {sep_status_color}'>{round(sep_score, 1)}%</span></p>"
                f"<p class='text-xs text-gray-400'>Metrik: (Desa Ideal Minimum / Desa Aktual Terpilih). Skor 100% berarti solusi yang paling ringkas (efisien) ditemukan.</p>"
                f"</div>"
            )

            # Bagian Status Akhir (Sama)
            if volume_terkumpul >= kebutuhan_volume:
                # ... (Logika Status Terpenuhi) ...
                surplus = volume_terkumpul - kebutuhan_volume
                
                html_output.append("<h5 class='text-lg font-bold text-green-400'>Status: Kebutuhan <span class='text-white'>TERPENUHI</span></h5>")
                html_output.append(f"<p class='text-md mt-2 text-white'>Total Volume Terkumpul: <span class='font-extrabold text-green-400'>{volume_terkumpul} ml</span> (Surplus <span class='font-bold'>{surplus} ml</span>)</p>")
                html_output.append(f"<p class='text-md text-white'>Jumlah Desa yang Diambil: <span class='font-extrabold text-yellow-400'>{actual_desa_count}</span></p>")

                html_output.append("<h5 class='text-lg font-bold text-blue-400 mt-4'>Detail Kontribusi Volume:</h5>")
                
                html_output.append("<ul class='list-none space-y-1 p-3 bg-gray-700/50 rounded-lg'>")
                html_output.append(f"<li class='flex justify-between border-b border-gray-600 pb-1'><span>GD Spesifik ({kebutuhan_gd_label}):</span><span class='font-extrabold text-white'>{volume_terkumpul_primary} ml</span></li>")
                
                if volume_terkumpul_universal > 0:
                    html_output.append(f"<li class='flex justify-between'><span>GD Universal (O - Fallback):</span><span class='font-extrabold text-white text-red-400'>{volume_terkumpul_universal} ml</span></li>")
                
                html_output.append("</ul>")

                html_output.append("<h5 class='text-lg font-bold text-blue-400 mt-4'>Desa yang Dioptimalkan (Diambil):</h5>")
                html_output.append("<ul class='list-none space-y-1 p-2 bg-gray-700/50 rounded-lg'>")
                
                all_selections_aggregated = defaultdict(int)
                for kode_desa, diambil, _ in selections_primary:
                     all_selections_aggregated[kode_desa] += diambil
                for kode_desa, diambil, _ in selections_universal:
                     all_selections_aggregated[kode_desa] += diambil
                
                for kode_desa in sorted(all_selections_aggregated.keys()):
                     html_output.append(
                        f"<li class='flex justify-between'>"
                        f"<span>Desa <span class='font-bold text-yellow-400'>0{kode_desa}</span>:</span>"
                        f"<span class='font-extrabold text-white'>{all_selections_aggregated[kode_desa]} ml</span>"
                        f"</li>"
                    )
                html_output.append("</ul>")
                
                result_html = "\n".join(html_output)
            else:
                # ... (Logika Status Kurang) ...
                kekurangan = kebutuhan_volume - volume_terkumpul
                
                html_output.append("<h5 class='text-lg font-bold text-red-400'>Status: Kebutuhan <span class='text-white'>KURANG</span></h5>")
                html_output.append(f"<p class='text-md mt-2 text-white'>Total Volume Terkumpul (Termasuk Fallback): <span class='font-extrabold text-red-400'>{volume_terkumpul} ml</span></p>")
                html_output.append(f"<p class='text-md text-white'>Kekurangan yang Dibutuhkan: <span class='font-extrabold text-yellow-400'>{kekurangan} ml</span></p>")

                if volume_terkumpul_primary > 0 or volume_terkumpul_universal > 0:
                    html_output.append("<h5 class='text-lg font-bold text-blue-400 mt-4'>Kontribusi Maksimal (Primary & Fallback):</h5>")
                    html_output.append("<ul class='list-none space-y-1 p-3 bg-gray-700/50 rounded-lg'>")
                    html_output.append(f"<li class='flex justify-between'><span>GD Spesifik ({kebutuhan_gd_label}):</span><span class='font-extrabold text-white'>{volume_terkumpul_primary} ml</span></li>")
                    if volume_terkumpul_universal > 0:
                         html_output.append(f"<li class='flex justify-between'><span>GD Universal (O - Fallback):</span><span class='font-extrabold text-white text-red-400'>{volume_terkumpul_universal} ml</span></li>")
                    html_output.append("</ul>")
                else:
                    html_output.append("<p class='mt-3 text-white/70'>Tidak ada desa yang memiliki stok golongan darah yang dibutuhkan, bahkan dengan fallback.</p>")
                
                result_html = "\n".join(html_output)

            
            # --- START SUB-SECTION AUDIT LOGISTIK SISA ---

            html_output.append("<hr class='my-5 border-indigo-700'>")
            html_output.append("<h4 class='text-xl font-extrabold text-yellow-400 mb-3'>Audit Logistik: Ketersediaan Sisa & Resiliensi 🛡️</h4>")
            
            # 1. Analisis Risiko Pasca-Optimasi
            html_output.append("<h5 class='text-lg font-bold text-gray-400 mt-4'>Risiko Pasca-Pengambilan (Resiliensi Sistem)</h5>")
            html_output.append("<ul class='list-none space-y-1 p-3 bg-gray-700/50 rounded-lg'>")
            
            gd_to_audit = [kebutuhan_gd_code]
            if kebutuhan_gd_code != 4: gd_to_audit.append(4) # Audit GD O jika digunakan sebagai fallback
            
            for gd_code in set(gd_to_audit):
                res = risk_after.get(gd_code, {'score': 0, 'volume': 0, 'status': 'N/A'})
                
                color_class = 'risk-score-low' if res['status'] == 'Rendah' else ('risk-score-medium' if res['status'] == 'Sedang' else 'risk-score-high')
                status_text = f"<span class='font-extrabold {color_class}'>{res['status']}</span>"
                
                html_output.append(
                    f"<li class='flex justify-between'>"
                    f"<span>Risiko GD {GOLONGAN_DARAH_MAP[gd_code]} (Stok Sisa):</span>"
                    f"<span>{status_text} ({res['score']} / {res['volume']} ml)</span>"
                    f"</li>"
                )
            html_output.append("</ul>")
            
            # 2. Stok Sisa Per Desa
            html_output.append("<h5 class='text-lg font-bold text-gray-400 mt-4'>Stok Sisa (ml) di Desa yang Diambil:</h5>")
            
            # Menggabungkan desa yang diambil dari primary dan universal selection
            desas_diambil_map = defaultdict(lambda: {'GD_PRIM_SISA': 0, 'GD_UNIV_SISA': 0})
            
            for kode_desa, diambil, sisa in selections_primary:
                desas_diambil_map[kode_desa]['GD_PRIM_SISA'] = sisa
            for kode_desa, diambil, sisa in selections_universal:
                desas_diambil_map[kode_desa]['GD_UNIV_SISA'] = sisa
            
            if desas_diambil_map:
                html_output.append("<ul class='list-none space-y-1 p-2 bg-gray-700/50 rounded-lg text-sm'>")
                
                for kode_desa in sorted(desas_diambil_map.keys()):
                    sisa_prim = desas_diambil_map[kode_desa]['GD_PRIM_SISA']
                    sisa_univ = desas_diambil_map[kode_desa]['GD_UNIV_SISA']
                    
                    details = []
                    if sisa_prim > 0:
                        details.append(f"{kebutuhan_gd_label}: {sisa_prim} ml")
                    if sisa_univ > 0 and kebutuhan_gd_code != 4:
                         details.append(f"O (Univ): {sisa_univ} ml")

                    html_output.append(
                        f"<li class='flex justify-between'>"
                        f"<span>Desa <span class='font-bold text-yellow-400'>0{kode_desa}</span>:</span>"
                        f"<span>{', '.join(details)}</span>"
                        f"</li>"
                    )
                html_output.append("</ul>")
            else:
                 html_output.append("<p class='text-sm text-gray-400/70'>Tidak ada desa yang diambil.</p>")

            # --- END SUB-SECTION AUDIT LOGISTIK SISA ---

            result_html = "\n".join(html_output)
            
            # Visualisasi (Sama seperti sebelumnya)
            target_volume_data = [kebutuhan_volume for _ in range(M)]

            primary_data = [primary_stock.get(i, 0) for i in range(1, M + 1)]
            universal_data = [universal_stock.get(i, 0) for i in range(1, M + 1)]

            datasets = [{
                'label': f'Stok GD {kebutuhan_gd_label} Spesifik (ml)',
                'data': primary_data,
                **DEFAULT_LINE_CHART_CONFIG
            }]
            
            if kebutuhan_gd_code != 4:
                 datasets.append({
                    'label': 'Stok GD O (Universal) Tersedia (ml)',
                    'data': universal_data, 
                    'borderColor': '#f87171',
                    'backgroundColor': 'rgba(248, 113, 113, 0.1)',
                    'tension': 0.4, 
                    'fill': False,
                    'pointBackgroundColor': '#f87171',
                    'borderWidth': 1.5,
                    'borderDash': [5, 5]
                })

            datasets.append({
                'label': 'Volume Kebutuhan Target (ml)',
                'data': target_volume_data, 
                'borderColor': '#dc2626',
                'borderDash': [8, 8],
                'borderWidth': 2,
                'pointRadius': 0,
                'backgroundColor': 'transparent',
            })

            chart_data = ['line', f"Stok GD Spesifik & Universal per Desa vs. Kebutuhan Target", desa_labels, datasets]
            return result_html, chart_data
        
        def solve_subproblem_3(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels):
            return solve_subproblem_optimasi(N, M, dds_data, GD_Keb, Volume_Keb, mode='volume', desa_labels=desa_labels)
            
        def solve_subproblem_4(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels):
            return solve_subproblem_optimasi(N, M, dds_data, GD_Keb, Volume_Keb, mode='buffer', desa_labels=desa_labels)


        def run_analysis(event=None):
            if event and hasattr(event, 'stop_propagation'):
                event.stop_propagation() 
            
            try:
                N, M, dds_data, GD_Keb, Volume_Keb, desa_labels = get_all_inputs()
                
                window.lastRawData = dds_data

                if N == 0 or M == 0:
                    document["output_text"].innerHTML = f"<span class='text-red-400 font-bold'>Error:</span> Harap masukkan data DDS yang valid. N={N}, M={M}. Pastikan Volume Darah > 0."
                    return
                
                selected_radio = document["subproblem_selector"].select('input[name="subproblem"]:checked')
                if not selected_radio:
                    document["output_text"].innerHTML = f"<span class='text-red-400 font-bold'>Error:</span> Silakan pilih Mode Analisis."
                    return
                
                subproblem_id = int(selected_radio[0].value)

                document["status_message"].classList.remove("hidden")
                document["output_text"].innerHTML = "<div class='text-white flex items-center justify-center h-48'><svg class='animate-spin h-6 w-6 mr-3 text-white' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'><circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle><path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'></path></svg>Menjalankan subproblem, mohon tunggu...</div>"
                
                chart_data = None

                # 2. Selesaikan Subproblem
                if subproblem_id == 1:
                    result_html, chart_data = solve_subproblem_1(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels)
                elif subproblem_id == 2:
                    result_html, chart_data = solve_subproblem_2(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels)
                elif subproblem_id == 3:
                    result_html, chart_data = solve_subproblem_3(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels)
                elif subproblem_id == 4:
                    result_html, chart_data = solve_subproblem_4(N, M, dds_data, GD_Keb, Volume_Keb, desa_labels)
                else:
                    result_html = "Error: Subproblem tidak dikenal."

                # 3. Update Output
                document["output_text"].innerHTML = result_html
                window.lastAnalysisHtml = result_html
                
                if chart_data is not None:
                    chart_type, title, labels, datasets = chart_data
                    window.draw_chart(chart_type, title, labels, datasets)

            except Exception as e:
                error_message = f"<span class='text-red-400 font-bold'>Error Sistem:</span> Terjadi Kesalahan Teknis: {e}"
                document["output_text"].innerHTML = error_message
                console.error(error_message)

            finally:
                document["status_message"].classList.add("hidden")

        def initialize():
            document["run_button"].bind("click", run_analysis)
            initialize_dashboard() 

        initialize()
        
    </script>
</body>
</html>

